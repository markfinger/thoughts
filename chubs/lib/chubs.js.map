{"version":3,"sources":["../src/chubs.js"],"names":[],"mappings":"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","file":"chubs.js","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport http from 'http';\nimport express from 'express';\nimport {transform, types} from 'babel-core';\nimport resolve from 'resolve';\nimport _ from 'lodash';\nimport Watchpack from 'watchpack';\nimport ws from 'ws';\nimport nodeLibsBrowser from 'node-libs-browser';\nimport logger from './logger';\n\nconst emptyMock = resolve.sync(`node-libs-browser/mock/empty`);\nconst nodeLibs = _.mapValues(nodeLibsBrowser, (filename, dep) => {\n  if (filename) {\n    return filename;\n  }\n\n  try {\n    return resolve.sync(`node-libs-browser/mock/${dep}`);\n  } catch(err) {\n    return emptyMock;\n  }\n});\n\nlet entry;\n\nlet moduleId = 0;\nconst modules = Object.create(null);\nconst modulesByFilename = Object.create(null);\n\nconst wp = new Watchpack();\n\nconst app = express();\nconst server = http.Server(app);\nconst wss = new ws.Server({server});\n\nlet connections = [];\n\nwss.on('connection', function(ws) {\n  console.log('websocket connected');\n\n  connections.push(ws);\n\n  ws.on('close', function() {\n    console.log('websocket closed');\n    connections = _.without(connections, ws);\n  });\n});\n\napp.get('/', function(req, res) {\n  const script = generateScript(modules, getModuleByFilename(entry));\n\n  res.end(`\n<html>\n<body>\n  <script>\n    ${script}\n  </script>\n</body>\n</html>\n  `);\n});\n\nserver.listen(8000, function() {\n  console.log('listening at http://127.0.0.1:8000');\n});\n\nconst resolveLog = logger('resolve');\nconst depLog = logger('dep');\nconst parseLog = logger('parse');\nconst parseDepLog = logger('parse-dep');\nconst moduleLog = logger('module');\nconst buildLog = logger('build');\nconst buildPerfLog = logger('build-perf');\n\nfunction getDep(filename, dep) {\n  resolveLog(`resolving dep \"${dep}\" from ${filename}`);\n\n  let depPath;\n  if (dep === 'inherits') {\n    depPath = resolve.sync('./hacks/inherits_browser.js');\n  } else if (dep in nodeLibs) {\n    depPath = nodeLibs[dep];\n  } else {\n    depPath = resolve.sync(dep, {\n      basedir: path.dirname(filename)\n    });\n  }\n\n  resolveLog(`resolved dep \"${dep}\" to ${depPath}`);\n\n  return getModuleByFilename(depPath);\n}\n\nfunction addDep(filename, name) {\n  let depModule = getDep(filename, name);\n  let mod = getModuleByFilename(filename);\n\n  if (!_.contains(depModule.dependents, mod.id)) {\n    depModule.dependents.push(mod.id);\n  }\n\n  if (!_.contains(mod.dependencies, depModule.id)) {\n    mod.dependencies.push(depModule.id);\n  }\n\n  depLog(`Added dep \"${depModule.id}\" to ${mod.id}`);\n\n  return depModule;\n}\n\nfunction getModuleByFilename(filename) {\n  moduleLog(`request for module \"${filename}\"`);\n\n  let id = modulesByFilename[filename];\n\n  if (id && modules[id]) {\n    return modules[id];\n  } else if (!id) {\n    id = (++moduleId).toString();\n  }\n\n  const mod = {\n    id: id,\n    filename: filename,\n    dependencies: [],\n    dependents: []\n  };\n\n  modules[id] = mod;\n  modulesByFilename[filename] = id;\n\n  moduleLog(`created module ${mod.id} for \"${filename}\"`);\n\n  return mod;\n}\n\nfunction getModuleById(id) {\n  return modules[id];\n}\n\nlet depTransform = 'chubs-deps';\n\ntransform.pipeline.addTransformer(\n  depTransform,\n  {\n    visitor: {\n      //Program: {\n      //  exit(node, parent, scope, context) {\n      //    if (context.__mockProcess) {\n      //      debugger\n      //    }\n      //  }\n      //},\n      //ExpressionStatement: {\n      //  exit(node, parent, scope, context) {\n      //    if (types.isIdentifier(node.object) && node.object.name === 'process') {\n      //      context.__mockProcess = true;\n      //    }\n      //  }\n      //},\n      CallExpression: {\n        exit(node, parent, scope, context) {\n          const name = node.callee.name;\n\n          if (name === 'require') {\n            if (node.arguments.length != 1) {\n              throw new Error(`Can only process requires with one arg: ${JSON.stringify(node)}`);\n            }\n\n            const dep = node.arguments[0];\n            const filename = context.opts.filename;\n\n            let depModule;\n\n            // TODO: non-hacky way to avoid dynamic requires\n            if (!types.isLiteral(dep)) {\n              depModule = getModuleByFilename(emptyMock);\n              node.arguments = [types.literal(JSON.stringify(depModule.id))];\n              return;\n            }\n\n            parseDepLog(`found dep \"${dep.value}\" in ${filename}`);\n            depModule = addDep(filename, dep.value);\n\n            parseDepLog(`rewriting dep \"${dep.value}\" to \"${depModule.id}\"`);\n            dep.value = depModule.id + '';\n          }\n        }\n      }\n    }\n  }\n);\n\nfunction build(mod) {\n  const filename = mod.filename;\n\n  if (!mod.code) {\n    buildLog(`building ${filename}`);\n\n    const buildStart = Date.now();\n\n    buildLog(`reading ${filename}`);\n\n    let whitelist;\n    if (/node_modules/.test(filename)) {\n      whitelist = [depTransform];\n    }\n\n    const contents = fs.readFileSync(filename).toString();\n\n    const parseStart = Date.now();\n    const data = transform(contents, {\n      filename: filename,\n      whitelist: whitelist\n      //sourceMaps: true,\n      //sourceFileName: path.basename(filename),\n      //sourceMapTarget: path.basename(filename) + '.map'\n    });\n    const parseEnd = Date.now();\n\n    parseLog(`Spent ${parseEnd - parseStart}ms parsing ${filename}`);\n\n    mod.code = data.code;\n\n    const buildEnd = Date.now();\n    buildPerfLog(`Spent ${buildEnd - buildStart}ms building ${filename}`);\n  }\n\n  if (mod.dependencies.length) {\n    const buildDepsStart = Date.now();\n\n    mod.dependencies.forEach((id) => {\n      let depModule = getModuleById(id);\n      if (!depModule.code) {\n        build(depModule);\n      }\n    });\n\n    const buildDepsEnd = Date.now();\n    buildPerfLog(`Spent ${buildDepsEnd - buildDepsStart}ms building dependencies for ${filename}`);\n  }\n}\n\nfunction defineModule(mod) {\n  const commentDivider = _.repeat('-', mod.filename.length);\n\n  return `\n// --------------------${commentDivider}\n// Module ${mod.id} -> ${mod.filename}\n// --------------------${commentDivider}\n__define('${mod.id}', function(module, exports, require) {\n${mod.code}\n});`;\n}\n\nfunction defineModules(modules) {\n  return _.map(modules, defineModule);\n}\n\nfunction generateScript(modules, entryModule) {\n  return `\n(function(__global) {\n// TODO: remove this\nwindow.require = __require;\n\n// Mock the process global\nvar process = {env: {}};\n\n// A map of module ids to module functions\nvar __moduleDefinitions = Object.create(null);\n\n// A store of the cached output from the module definitions\nvar __requireCache = Object.create(null);\n\n// The \\`require\\` function used by the modules\nfunction __require(dep) {\n  if (__requireCache[dep] !== undefined) {\n    return __requireCache[dep];\n  }\n\n  var moduleDefinition = __moduleDefinitions[dep];\n  if (moduleDefinition === undefined) {\n    throw new Error('Module \"' + dep + '\" has no definition');\n  }\n\n  var _module = {exports: {}};\n\n  // Prepopulate the require cache early to avoid circular dependencies\n  __requireCache[dep] = {};\n\n  moduleDefinition.call(__global, _module, _module.exports, __require);\n\n  __requireCache[dep] = _module.exports;\n\n  return _module.exports;\n};\n\n// Populates the module definitions\nfunction __define(id, func) {\n  __moduleDefinitions[id] = func;\n};\n\n${defineModules(modules).join('\\n\\n')}\n\n\n// Call ${entryModule.filename}\n__require('${entryModule.id}');\n\n})(this);\n  `;\n}\n\nfunction watch(modules, startTime) {\n  const filenames = _(modules).values().pluck('filename').value();\n\n  wp.watch(filenames, [], startTime);\n}\n\nfunction chubs(opts, cb) {\n  const startTime = Date.now();\n\n  entry = opts.entry;\n  if (!entry) {\n    throw new Error(`Entry option was not defined in ${JSON.stringify(opts)}`);\n  }\n\n  if (!path.isAbsolute(entry)) {\n    entry = path.resolve(entry);\n  }\n\n  console.log(`Entry: ${entry}`);\n\n  let mod = getModuleByFilename(entry);\n\n  build(mod);\n\n  watch(modules, startTime);\n\n  wp.on('change', function(filename) {\n    const mod = getModuleByFilename(filename);\n    mod.code = undefined;\n    build(mod);\n    console.log(`Rebuilt module '${mod.id}' => ${mod.filename}`);\n    connections.forEach(ws => ws.send(JSON.stringify(mod)));\n  });\n\n  //cb({\n  //  startTime,\n  //  entry,\n  //  output: generateScript(modules, entry),\n  //  modules\n  //});\n}\n\nexport default chubs;"]}